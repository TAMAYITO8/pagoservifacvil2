<!DOCTYPE html>
<html>
<head>
  <title>Guardar tarjeta</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    #card-element {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h2>Guardar tarjeta de manera segura</h2>

  <input type="email" id="email" placeholder="Correo electrónico" />
  <div id="card-element"></div>
  <button id="guardar-btn">Guardar tarjeta</button>

  <div id="resultado"></div>

  <script>
    const stripe = Stripe("pk_live_51RF2n3LI4r5KKtZXGwwNRl6yv3zXXrIMzuf2xxgLwGw7hgec61U4jcYp8fdlfQg2qGOjJHXkpWef9u3BIb4WYChz005oFicdrF"); // TU CLAVE PUBLICABLE

    const elements = stripe.elements();
    const card = elements.create("card");
    card.mount("#card-element");

    document.getElementById("guardar-btn").addEventListener("click", async () => {
      document.getElementById("resultado").textContent = "Procesando...";

      // Obtener el client_secret desde tu backend
      const res = await fetch("/create-setup-intent");
      const data = await res.json();

      const result = await stripe.confirmCardSetup(data.client_secret, {
        payment_method: {
          card: card,
          billing_details: {
            email: document.getElementById("email").value
          }
        }
      });

      if (result.error) {
        document.getElementById("resultado").textContent = "❌ Error: " + result.error.message;
      } else {
        // Ahora envía el payment_method a tu backend para guardarlo
        const r = await fetch("/guardar_tarjeta", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            payment_method: result.setupIntent.payment_method
          })
        });

        const respuesta = await r.json();

        if (respuesta.error) {
          document.getElementById("resultado").textContent = "❌ Backend: " + respuesta.error;
        } else {
          document.getElementById("resultado").textContent = "✅ Tarjeta guardada para cliente: " + respuesta.customer_id;
        }
      }
    });
  </script>
</body>
</html>
